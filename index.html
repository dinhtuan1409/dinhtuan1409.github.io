<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gi·∫£i ƒë·ªë ƒë·ªÉ m·ªü kh√≥a</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-text': '#2c3e50',
                        'custom-accent': '#7aa8bf',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* CSS cho c√°c m·∫£nh gh√©p */
        .puzzle-piece {
            cursor: grab; /* Thay ƒë·ªïi con tr·ªè khi k√©o */
            transition: border 0.2s;
            position: absolute; 
            user-select: none;
            touch-action: none;
            border: 2px solid transparent;
        }
        .puzzle-piece.dragging {
            opacity: 0.8;
            z-index: 1000;
            cursor: grabbing;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        .puzzle-piece.correct {
            border: 2px solid #4CAF50; /* M√†u xanh l√° khi ƒë√∫ng v·ªã tr√≠ */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="puzzle-container" class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-lg w-full">
        <h1 class="text-3xl font-bold mb-4 text-custom-text">üîì M·ªü kh√≥a Website k·ª∑ ni·ªám</h1>
        <p class="text-lg text-gray-600 mb-6">H√£y gh√©p ƒë√∫ng b·ª©c tranh n√†y ƒë·ªÉ th·∫•y ƒëi·ªÅu b·∫•t ng·ªù!</p>
        
        <div id="puzzle-board" class="relative mx-auto border-4 border-custom-accent shadow-inner" style="width: 300px; height: 300px;">
            </div>

        <button id="check-btn" class="mt-8 bg-custom-accent text-white py-3 px-6 rounded-lg text-xl font-semibold hover:bg-[#6c91a4] transition duration-300">
            Ki·ªÉm tra
        </button>

        <p id="message" class="mt-4 text-lg font-semibold h-6"></p>
    </div>

    <script>
        // ƒê·∫£m b·∫£o to√†n b·ªô m√£ JS ch·ªâ ch·∫°y sau khi trang ƒë√£ t·∫£i xong
        document.addEventListener('DOMContentLoaded', (event) => {
            
            const BOARD_SIZE = 300; // K√≠ch th∆∞·ªõc khung (px)
            const ROWS = 3;
            const COLS = 3;
            const PIECE_SIZE = BOARD_SIZE / ROWS; // 100px
            const TARGET_URL = 'anniversary.html'; // T√™n file website 2 nƒÉm c·ªßa b·∫°n

            const puzzleBoard = document.getElementById('puzzle-board');
            const checkBtn = document.getElementById('check-btn');
            const messageEl = document.getElementById('message');
            
            // KI·ªÇM TRA ƒê∆Ø·ªúNG D·∫™N N√ÄY PH·∫¢I ƒê√öNG 100%
            const IMAGE_SRC = 'img/anh10.jpg'; 

            let pieces = [];
            let isGameComplete = false;
            let dragElement = null;

            // 1. KH·ªûI T·∫†O M·∫¢NH GH√âP
            function createPieces() {
                // T·∫£i ·∫£nh ƒë·ªÉ ki·ªÉm tra (kh√¥ng b·∫Øt bu·ªôc, nh∆∞ng t·ªët h∆°n)
                const img = new Image();
                img.onload = () => {
                    // N·∫øu ·∫£nh t·∫£i th√†nh c√¥ng th√¨ t·∫°o m·∫£nh gh√©p
                    _generatePieces();
                    shuffleAndPlacePieces(pieces);
                };
                img.onerror = () => {
                    // N·∫øu ·∫£nh kh√¥ng t·∫£i ƒë∆∞·ª£c, hi·ªán c·∫£nh b√°o
                    puzzleBoard.innerHTML = `<div class="absolute inset-0 flex items-center justify-center bg-red-100 text-red-600 text-sm p-4">‚ùå L·ªñI: Kh√¥ng t√¨m th·∫•y file ·∫£nh: ${IMAGE_SRC}</div>`;
                    checkBtn.disabled = true;
                    checkBtn.textContent = 'L·ªói ·∫£nh';
                };
                img.src = IMAGE_SRC; 
            }

            function _generatePieces() {
                puzzleBoard.innerHTML = ''; 
                pieces = [];

                for (let r = 0; r < ROWS; r++) {
                    for (let c = 0; c < COLS; c++) {
                        const index = r * COLS + c;

                        const piece = document.createElement('div');
                        piece.classList.add('puzzle-piece');
                        // L∆∞u v·ªã tr√≠ ƒë√∫ng
                        piece.dataset.correctRow = r;
                        piece.dataset.correctCol = c;
                        piece.dataset.index = index;
                        
                        // Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc v√† ·∫£nh n·ªÅn
                        piece.style.width = PIECE_SIZE + 'px';
                        piece.style.height = PIECE_SIZE + 'px';
                        piece.style.backgroundImage = `url(${IMAGE_SRC})`;
                        piece.style.backgroundSize = `${BOARD_SIZE}px ${BOARD_SIZE}px`;
                        piece.style.backgroundPosition = `-${c * PIECE_SIZE}px -${r * PIECE_SIZE}px`;

                        pieces.push(piece);
                    }
                }
                
                // G√°n s·ª± ki·ªán K√©o Th·∫£ (Sau khi t·∫°o m·∫£nh gh√©p)
                pieces.forEach(piece => {
                    piece.addEventListener('mousedown', startDrag);
                    piece.addEventListener('touchstart', startDrag); 
                });
            }

            // 2. X√ÅO TR·ªòN V√Ä ƒê·∫∂T M·∫¢NH GH√âP NG·∫™U NHI√äN
            function shuffleAndPlacePieces(arr) {
                // X√°o tr·ªôn m·∫£ng (Fisher-Yates)
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                
                // ƒê·∫∑t m·∫£nh gh√©p v√†o v·ªã tr√≠ ng·∫´u nhi√™n tr√™n board (ban ƒë·∫ßu)
                arr.forEach((piece) => {
                    // T·∫°o m·ªôt v·ªã tr√≠ ng·∫´u nhi√™n
                    const r = Math.floor(Math.random() * ROWS); 
                    const c = Math.floor(Math.random() * COLS);

                    piece.style.top = r * PIECE_SIZE + 'px';
                    piece.style.left = c * PIECE_SIZE + 'px';

                    puzzleBoard.appendChild(piece);
                });
            }

            // 3. X·ª¨ L√ù K√âO TH·∫¢ (Drag and Drop)
            function startDrag(e) {
                if (isGameComplete) return;

                const event = e.touches ? e.touches[0] : e;
                dragElement = this;
                dragElement.classList.add('dragging');
                
                // ƒê∆∞a m·∫£nh gh√©p l√™n tr√™n c√πng khi k√©o
                dragElement.style.zIndex = 1001; 

                const rect = dragElement.getBoundingClientRect();
                const offsetX = event.clientX - rect.left;
                const offsetY = event.clientY - rect.top;
                const boardRect = puzzleBoard.getBoundingClientRect();

                function moveDrag(e) {
                    if (!dragElement) return;
                    const event = e.touches ? e.touches[0] : e;

                    let newX = event.clientX - offsetX;
                    let newY = event.clientY - offsetY;

                    // C·∫≠p nh·∫≠t v·ªã tr√≠ c·ªßa m·∫£nh gh√©p (relative to the board's parent)
                    dragElement.style.left = (newX - boardRect.left) + 'px';
                    dragElement.style.top = (newY - boardRect.top) + 'px';
                }

                function endDrag(e) {
                    if (!dragElement) return;
                    
                    // X·ª≠ l√Ω logic snap-to-grid v√† ki·ªÉm tra
                    snapToGrid(dragElement);
                    
                    dragElement.classList.remove('dragging');
                    dragElement.style.zIndex = ''; // Reset z-index
                    dragElement = null;
                    
                    document.removeEventListener('mousemove', moveDrag);
                    document.removeEventListener('mouseup', endDrag);
                    document.removeEventListener('touchmove', moveDrag);
                    document.removeEventListener('touchend', endDrag);
                }

                document.addEventListener('mousemove', moveDrag);
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchmove', moveDrag);
                document.addEventListener('touchend', endDrag);
                
                e.preventDefault(); 
            }

            // 4. LOGIC SNAP-TO-GRID V√Ä KI·ªÇM TRA ƒê√öNG V·ªä TR√ç
            function snapToGrid(piece) {
                const currentX = parseFloat(piece.style.left);
                const currentY = parseFloat(piece.style.top);

                // T√≠nh to√°n v·ªã tr√≠ c·ªôt v√† h√†ng g·∫ßn nh·∫•t
                let targetCol = Math.round(currentX / PIECE_SIZE);
                let targetRow = Math.round(currentY / PIECE_SIZE);

                // Gi·ªõi h·∫°n l·∫°i trong ph·∫°m vi (0 -> 2)
                targetCol = Math.min(Math.max(0, targetCol), COLS - 1);
                targetRow = Math.min(Math.max(0, targetRow), ROWS - 1);
                
                // ƒê·∫£m b·∫£o kh√¥ng c√≥ m·∫£nh gh√©p n√†o kh√°c ƒëang ·ªü v·ªã tr√≠ n√†y
                // (Logic n√†y b·ªã l∆∞·ª£c b·ªè ƒë·ªÉ ƒë∆°n gi·∫£n h√≥a, c√≥ th·ªÉ th√™m sau)

                // ƒê·∫∑t m·∫£nh gh√©p v√†o v·ªã tr√≠ l∆∞·ªõi
                piece.style.left = targetCol * PIECE_SIZE + 'px';
                piece.style.top = targetRow * PIECE_SIZE + 'px';

                checkCorrectness(piece);
            }
            
            // Ki·ªÉm tra xem m·∫£nh gh√©p c√≥ ƒëang ·ªü v·ªã tr√≠ ƒë√∫ng (h√†ng v√† c·ªôt) hay kh√¥ng
            function checkCorrectness(piece) {
                const currentLeft = parseFloat(piece.style.left);
                const currentTop = parseFloat(piece.style.top);

                // L·∫•y v·ªã tr√≠ l∆∞·ªõi hi·ªán t·∫°i (ƒë√£ l√†m tr√≤n)
                const currentRow = Math.round(currentTop / PIECE_SIZE);
                const currentCol = Math.round(currentLeft / PIECE_SIZE);

                const isCorrect = 
                    parseInt(piece.dataset.correctRow) === currentRow &&
                    parseInt(piece.dataset.correctCol) === currentCol;
                
                piece.classList.toggle('correct', isCorrect);
                return isCorrect;
            }

            // 5. KI·ªÇM TRA TO√ÄN B·ªò V√Ä CHUY·ªÇN H∆Ø·ªöNG
            checkBtn.addEventListener('click', () => {
                if (isGameComplete) return;

                let allCorrect = true;
                
                // Ki·ªÉm tra xem c√≥ m·∫£nh gh√©p n√†o ƒë·∫∑t ƒë√∫ng v·ªã tr√≠ kh√¥ng
                pieces.forEach(piece => {
                    if (!checkCorrectness(piece)) {
                        allCorrect = false;
                    }
                });
                
                // Ki·ªÉm tra xem c√≥ m·∫£nh gh√©p n√†o b·ªã tr√πng v·ªã tr√≠ kh√¥ng (R·∫•t quan tr·ªçng)
                const occupiedPositions = new Set();
                pieces.forEach(piece => {
                    const currentLeft = parseFloat(piece.style.left);
                    const currentTop = parseFloat(piece.style.top);
                    const key = `${currentLeft},${currentTop}`;
                    
                    if(occupiedPositions.has(key)) {
                        allCorrect = false; // B·ªã tr√πng v·ªã tr√≠
                    }
                    occupiedPositions.add(key);
                });

                if (allCorrect) {
                    messageEl.textContent = 'Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh b·ª©c tranh! üéâ';
                    isGameComplete = true;
                    
                    // T·∫Øt t∆∞∆°ng t√°c k√©o th·∫£
                    pieces.forEach(piece => piece.style.pointerEvents = 'none');
                    
                    // Chuy·ªÉn h∆∞·ªõng
                    setTimeout(() => {
                        window.location.href = TARGET_URL; 
                    }, 2000); 
                    
                    checkBtn.disabled = true;
                    checkBtn.textContent = 'ƒêang chuy·ªÉn h∆∞·ªõng...';
                    checkBtn.classList.remove('bg-custom-accent');
                    checkBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                } else {
                    messageEl.textContent = 'Ch∆∞a ƒë√∫ng, h√£y th·ª≠ s·∫Øp x·∫øp l·∫°i nh√©.';
                    checkBtn.classList.add('bg-red-500');
                    setTimeout(() => {
                        messageEl.textContent = '';
                        checkBtn.classList.remove('bg-red-500');
                    }, 1500);
                }
            });

            // B·∫Øt ƒë·∫ßu tr√≤ ch∆°i
            createPieces();
        });
    </script>
</body>
</html>